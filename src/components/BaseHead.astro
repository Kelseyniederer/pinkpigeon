---
import "../styles/global.css";
import { getEntry } from "astro:content";
import { THEME_PRESETS } from "@/utils/themePresets";

interface Props {
  title?: string;
  description?: string;
}

const { title = "Pink Pigeon", description = "A travel blog" } = Astro.props;

const themeEntry = await getEntry("settings", "theme");
const themeData = themeEntry?.data ?? { preset: "blush", accent: "", fontSans: "", fontDisplay: "" };
const preset = THEME_PRESETS[themeData.preset ?? "blush"] ?? THEME_PRESETS.blush;
const accent = (themeData.accent && themeData.accent.trim().length > 0) ? themeData.accent.trim() : preset.accent;
const fontSans = (themeData.fontSans && themeData.fontSans.trim().length > 0) ? themeData.fontSans.trim() : (preset.fontSans ?? "");
const fontDisplay = (themeData.fontDisplay && themeData.fontDisplay.trim().length > 0) ? themeData.fontDisplay.trim() : (preset.fontDisplay ?? "");
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>{title}</title>
<meta name="description" content={description} />

<style is:inline>
  {`
  :root {
    --color-accent: ${accent};
    --color-base-50: ${preset.base["50"]};
    --color-base-100: ${preset.base["100"]};
    --color-base-200: ${preset.base["200"]};
    --color-base-300: ${preset.base["300"]};
    --color-base-400: ${preset.base["400"]};
    --color-base-500: ${preset.base["500"]};
    --color-base-600: ${preset.base["600"]};
    --color-base-700: ${preset.base["700"]};
    --color-base-800: ${preset.base["800"]};
    --color-base-900: ${preset.base["900"]};
    --color-base-950: ${preset.base["950"]};
    ${fontSans ? `--font-sans: ${fontSans}; font-family: ${fontSans};` : ""}
    ${fontDisplay ? `--font-display: ${fontDisplay};` : ""}
  }
  `}
</style>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/favicon.png" />

<!-- Fonts -->
<link rel="preconnect" href="https://rsms.me/" />
<link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

<!-- Alpine.js -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Identity email links land on /#token=... by default.
     Redirect those straight to /admin/#token=... so the CMS can handle them. -->
<script>
  (() => {
    const hash = window.location.hash || "";
    const isIdentityToken =
      hash.includes("recovery_token=") ||
      hash.includes("invite_token=") ||
      hash.includes("confirmation_token=");

    // If someone clicks an Identity email link, send them to /admin with the same hash.
    if (isIdentityToken && !window.location.pathname.startsWith("/admin")) {
      window.location.replace(`/admin/${hash}`);
    }
  })();
</script>
